<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Redefinir Senha - RPG Educacional</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="./src/css/index.css" />
    <link rel="stylesheet" href="./src/css/modeIndex.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    />
    <script defer src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  </head>

  <body class="animated-bg font-sans h-screen overflow-hidden">
    <div class="h-full flex items-center justify-center p-4">
      <div
        class="login-card max-w-md w-full rounded-2xl max-h-full overflow-y-auto"
      >
        <div class="theme-toggle-container">
          <button
            id="themeToggle"
            class="theme-toggle"
            aria-label="Alternar tema"
            onclick="toggleTheme()"
          >
            <i id="theme-icon" class="fas fa-moon theme-icon-moon"></i>
          </button>
        </div>

        <div class="logo-title">
          <i class="fas fa-key logo-icon"></i>
          <h1 class="text-3xl font-bold">
            Redefinir<br /><span class="text-2xl">Senha</span>
          </h1>
        </div>

        <div id="reset-form">
          <p class="text-center text-gray-600 dark:text-gray-300 mb-6">
            Digite sua nova senha abaixo.
          </p>

          <div class="input-group">
            <input
              id="newPassword"
              type="password"
              placeholder="Nova senha"
              class="input-field"
              minlength="6"
            />
            <i class="fas fa-lock input-icon"></i>
            <button
              type="button"
              class="toggle-password"
              onclick="togglePasswordVisibility('newPassword', this)"
            >
              <i class="fas fa-eye"></i>
            </button>
          </div>

          <div class="input-group">
            <input
              id="confirmPassword"
              type="password"
              placeholder="Confirme a senha"
              class="input-field"
              minlength="6"
            />
            <i class="fas fa-lock input-icon"></i>
            <button
              type="button"
              class="toggle-password"
              onclick="togglePasswordVisibility('confirmPassword', this)"
            >
              <i class="fas fa-eye"></i>
            </button>
          </div>

          <button id="resetPasswordBtn" class="w-full btn-primary mb-4">
            <i class="fas fa-check mr-2"></i>
            Redefinir Senha
          </button>

          <a
            href="index.html"
            class="block text-center text-sm text-blue-600 dark:text-blue-400 hover:underline"
          >
            <i class="fas fa-arrow-left mr-1"></i>
            Voltar ao login
          </a>
        </div>
      </div>
    </div>

    <script type="module">
      import { applyThemeOnLoad, toggleTheme } from "./src/js/mode.js";
      import { showToast } from "./src/js/utils/toast.js";
      import { API_URL } from "./src/js/config.js";

      applyThemeOnLoad();
      window.toggleTheme = toggleTheme;

      // Pegar token da URL
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get("token");

      if (!token) {
        showToast("Link inválido ou expirado!", "error");
        setTimeout(() => {
          window.location.href = "index.html";
        }, 2000);
      }

      const resetPasswordBtn = document.getElementById("resetPasswordBtn");
      const newPassword = document.getElementById("newPassword");
      const confirmPassword = document.getElementById("confirmPassword");

      resetPasswordBtn.addEventListener("click", async () => {
        const password = newPassword.value;
        const confirm = confirmPassword.value;

        if (!password || !confirm) {
          showToast("Preencha todos os campos!", "error");
          return;
        }

        if (password.length < 6) {
          showToast("A senha deve ter no mínimo 6 caracteres!", "error");
          return;
        }

        if (password !== confirm) {
          showToast("As senhas não coincidem!", "error");
          return;
        }

        resetPasswordBtn.disabled = true;
        resetPasswordBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin mr-2"></i>Redefinindo...';

        try {
          const res = await fetch(`${API_URL}/auth/reset-password`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token, newPassword: password }),
          });

          const data = await res.json();

          if (res.ok) {
            showToast("Senha redefinida com sucesso!", "success");
            setTimeout(() => {
              window.location.href = "index.html";
            }, 2000);
          } else {
            showToast(data.error || "Erro ao redefinir senha", "error");
            resetPasswordBtn.disabled = false;
            resetPasswordBtn.innerHTML =
              '<i class="fas fa-check mr-2"></i>Redefinir Senha';
          }
        } catch (error) {
          showToast("Erro de conexão com o servidor", "error");
          resetPasswordBtn.disabled = false;
          resetPasswordBtn.innerHTML =
            '<i class="fas fa-check mr-2"></i>Redefinir Senha';
        }
      });

      // Enter key
      [newPassword, confirmPassword].forEach((input) => {
        input.addEventListener("keypress", (e) => {
          if (e.key === "Enter") resetPasswordBtn.click();
        });
      });

      // Função global para toggle de senha
      window.togglePasswordVisibility = function (inputId, button) {
        const input = document.getElementById(inputId);
        const icon = button.querySelector("i");

        if (input.type === "password") {
          input.type = "text";
          icon.classList.remove("fa-eye");
          icon.classList.add("fa-eye-slash");
        } else {
          input.type = "password";
          icon.classList.remove("fa-eye-slash");
          icon.classList.add("fa-eye");
        }
      };
    </script>
  </body>
</html>
